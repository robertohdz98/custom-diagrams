stateDiagram-v2
    state "ðŸ”“ Correct credentials" as CorrectCredentials
    state "âŒðŸ”’ Invalid Credentials" as InvalidCredentials 
    state "âœ… Correct Token" as CorrectToken
    state "âŒ Invalid / Error Token" as InvalidToken
    state "âŒ No Token Found" as NoTokenFound
    state "âœ… Token Exists In Session" as TokenExistsInSession
    state "âŒ› Expired Token" as ExpiredToken
    state "âŒ› Token Expiration" as TokenExpiration
    state "ðŸŸ¢ Active Session (app expected functioning)" as ActiveSession
    state "ðŸ” st.rerun" as st.rerun
    state "ðŸª Check cookies" as CheckCookies
    state "â” Check active user session" as TokenCheck
    state "ðŸ” Token refresh    (*sliding session**)" as TokenRefresh
    state "ðŸ”‘ JWT token decoding..." as ValidateToken
    state "ðŸ†•  Clears old session state + opens new session" as BrowserRefresh
    state "ðŸ–¥ï¸ Frontend Application (Streamlit) ðŸ–¥ï¸" as Streamlit_Frontend_Application
    state "ðŸšªðŸ” Redirection to **SSO URL** **login.microsoftonline.com/***" as CredentialsRequested

    [*] --> InitialState: ðŸ‘¥   User accesses **myapp.com/***
    state "Initial State" as InitialState {
        EmptySession: st.session_state = { }
        EmptySession: authenticated = False
        EmptySession: cookies = [ ]
    }
    InitialState --> CheckCookies
    
    CheckCookies --> TokenCheck: Look for *auth_token* in cookies or context headers

    TokenCheck --> TokenExistsInSession
    TokenCheck --> NoTokenFound
    
    TokenExistsInSession --> ValidateToken
    NoTokenFound --> CredentialsRequested

    ValidateToken --> ExpiredToken
    ValidateToken --> InvalidToken
    ValidateToken --> CorrectToken
    
    CredentialsRequested --> CorrectCredentials
    CredentialsRequested --> InvalidCredentials
    InvalidCredentials --> CredentialsRequested: Retry login
    CorrectCredentials --> TokenExistsInSession: Backend returns generated JWT from SAML response
    
    ExpiredToken --> st.rerun
    InvalidToken --> st.rerun
    st.rerun --> NoTokenFound: **ðŸ‘¤ authenticated = False**
    CorrectToken --> ActiveSession: **ðŸ‘¤ authenticated = True {username=..., email=...}**
    
    state Streamlit_Frontend_Application {
        ActiveSession --> TokenRefresh: ðŸŒ HTTP request to backend
        ActiveSession --> TokenExpiration: âŒ›  **User inactivity** (>*ACCESS_TOKEN_EXPIRATION_TIME* without any request)
        ActiveSession --> BrowserRefresh: ðŸ”„ User refreshes browser tab
        
        TokenRefresh --> ActiveSession: âž•  Update token in **st.session_state** (*exp* time) 
    }
    BrowserRefresh --> InitialState
    TokenExpiration --> CredentialsRequested: **ðŸš« Error 401 Unauthorized**
    

    %% Styling
    classDef errorState fill:#d3d3d3, stroke:#c62828, color:#c62828,font-weight:bold
    class TokenExpiration errorState
    class NoTokenFound errorState
    class InvalidCredentials errorState
    class ExpiredToken errorState
    class InvalidToken errorState
    
    classDef correctState fill:#d3d3d3, stroke:#008000, color:#008000,font-weight:bold
    class TokenRefresh correctState
    class TokenExistsInSession correctState
    class CorrectCredentials correctState
    class CorrectToken correctState

    classDef authenticatedState fill:#008000, stroke:#008000,font-weight:bold
    class AuthenticatedState authenticatedState
    class ActiveSession authenticatedState

    classDef refreshState fill:#d3d3d3, stroke:#0000FF, color:#0000FF, font-weight:bold
    class BrowserRefresh refreshState

    classDef sso fill:#ffa500, stroke:#ffa500, color:#000000, font-weight:bold
    class CredentialsRequested sso